<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Register - OdinDent</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <meta content="Free HTML Templates" name="keywords">
    <meta content="Free HTML Templates" name="description">

    <!-- Favicon -->
    <link href="/img/favicon.ico" rel="icon">

    <!-- Google Web Fonts -->
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Jost:wght@500;600;700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">

    <!-- Icon Font Stylesheet -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Libraries Stylesheet -->
    <link href="/lib/owlcarousel/assets/owl.carousel.min.css" rel="stylesheet">
    <link href="/lib/animate/animate.min.css" rel="stylesheet">

    <!-- Customized Bootstrap Stylesheet -->
    <link href="/css/bootstrap.min.css" rel="stylesheet">

    <!-- Template Stylesheet -->
    <link href="/css/style.css" rel="stylesheet">

    <style>
        .LogIn-container {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            padding: 30px;
            margin-top: 30px;
        }

        .form-control {
            padding: 12px 15px;
            margin-bottom: 1.2rem;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .btn-primary {
            padding: 12px;
            border-radius: 5px;
            font-weight: 600;
        }

        .auth-link {
            color: var(--primary);
            text-decoration: none;
            transition: all 0.3s;
        }

        .auth-link:hover {
            color: var(--secondary);
            text-decoration: underline;
        }

        .error-message {
            color: #dc3545;
            font-size: 0.875rem;
            margin-top: -10px;
            margin-bottom: 10px;
        }

        /* OTP Form Stilleri */
        #otpForm {
            display: none;
        }

        .otp-container {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }

        .otp-input {
            width: 50px;
            height: 50px;
            text-align: center;
            font-size: 1.2rem;
            border: 2px solid #dee2e6;
            border-radius: 5px;
        }
    </style>
</head>

<body>
<!-- Spinner Start -->
<div id="spinner" class="show bg-white position-fixed translate-middle w-100 vh-100 top-50 start-50 d-flex align-items-center justify-content-center">
    <div class="spinner-grow text-primary m-1" role="status">
        <span class="sr-only">Loading...</span>
    </div>
    <div class="spinner-grow text-dark m-1" role="status">
        <span class="sr-only">Loading...</span>
    </div>
    <div class="spinner-grow text-secondary m-1" role="status">
        <span class="sr-only">Loading...</span>
    </div>
</div>
<!-- Spinner End -->

<!-- Navbar Start -->
<nav class="navbar navbar-expand-lg bg-white navbar-light shadow-sm px-5 py-3 py-lg-0">
    <a th:href="@{/}" class="navbar-brand p-0">
        <h1 class="m-0 text-primary"><i class="fa fa-tooth me-2"></i>OdinDent</h1>
    </a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse">
        <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarCollapse">
        <div class="navbar-nav ms-auto py-0">
            <a th:href="@{/}" class="nav-item nav-link">Home</a>
            <a th:href="@{/about}" class="nav-item nav-link">About</a>
            <a th:href="@{/service}" class="nav-item nav-link">Service</a>
            <a th:href="@{/contact}" class="nav-item nav-link">Contact</a>
        </div>
        <a th:href="@{/LogIn}" class="btn btn-outline-primary ms-3">Login</a>
    </div>
</nav>
<!-- Navbar End -->

<!-- Register Form Start -->
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-6 col-lg-5">
            <!-- Register Form -->
            <div class="LogIn-container" id="registerForm">
                <h4 class="text-center mb-4">Create Your Account</h4>
                <form id="registerFormElement">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="firstName" class="form-label">First Name</label>
                            <input type="text" class="form-control" id="firstName" required placeholder="John">
                            <div id="firstNameError" class="error-message"></div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="lastName" class="form-label">Last Name</label>
                            <input type="text" class="form-control" id="lastName" required placeholder="Doe">
                            <div id="lastNameError" class="error-message"></div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="email" required placeholder="your@email.com">
                        <div id="emailError" class="error-message"></div>
                    </div>
                    <div class="mb-3">
                        <label for="phone" class="form-label">Phone Number</label>
                        <input type="tel" class="form-control" id="phone" placeholder="+994 50 123 4567">
                        <div id="phoneError" class="error-message"></div>
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">Password</label>
                        <input type="password" class="form-control" id="password" required placeholder="••••••••">
                        <div id="passwordError" class="error-message"></div>
                    </div>
                    <div class="mb-4">
                        <label for="confirmPassword" class="form-label">Confirm Password</label>
                        <input type="password" class="form-control" id="confirmPassword" required placeholder="••••••••">
                        <div id="confirmPasswordError" class="error-message"></div>
                    </div>
                    <div class="form-check mb-4">
                        <input class="form-check-input" type="checkbox" id="terms" required>
                        <label class="form-check-label" for="terms">
                            I agree to the <a href="#" class="auth-link">Terms of Service</a>
                        </label>
                        <div id="termsError" class="error-message"></div>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Register</button>
                    <p class="mt-3 text-center">Already have an account? <a href="/LogIn" class="auth-link">Login here</a></p>
                </form>
            </div>

            <!-- OTP Verification Form -->
            <div class="LogIn-container" id="otpForm">
                <h4 class="text-center mb-4">Verify OTP</h4>
                <p class="text-center">We sent a verification code to <strong id="userEmail"></strong></p>

                <div class="otp-container">
                    <input type="text" class="otp-input" id="otp1" maxlength="1" autofocus>
                    <input type="text" class="otp-input" id="otp2" maxlength="1">
                    <input type="text" class="otp-input" id="otp3" maxlength="1">
                    <input type="text" class="otp-input" id="otp4" maxlength="1">
                </div>

                <div class="d-grid gap-2 mt-4">
                    <button id="verifyOtpBtn" class="btn btn-success w-100">Verify & Register</button>
                    <button id="resendOtpBtn" class="btn btn-link">Resend OTP</button>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Register Form End -->

<!-- Footer Start -->
<footer class="container-fluid bg-dark text-white text-center py-4">
    <p class="mb-0">&copy; OdinDent 2025. All Rights Reserved.</p>
</footer>
<!-- Footer End -->

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="/lib/wow/wow.min.js"></script>
<script src="/lib/owlcarousel/owl.carousel.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const spinner = document.getElementById("spinner");
        const registerForm = document.getElementById("registerForm");
        const registerFormElement = document.getElementById("registerFormElement");
        const otpForm = document.getElementById("otpForm");
        const userEmailSpan = document.getElementById("userEmail");
        const verifyOtpBtn = document.getElementById("verifyOtpBtn");
        const resendOtpBtn = document.getElementById("resendOtpBtn");

        const API_BASE = "http://localhost:8020/api/v1/auth";
        let userData = {};

        if (spinner) spinner.classList.remove("show");

        const otpInputs = document.querySelectorAll('.otp-input');
        otpInputs.forEach((input, index) => {
            input.addEventListener('input', (e) => {
                if (e.target.value.length === 1 && index < otpInputs.length - 1) {
                    otpInputs[index + 1].focus();
                }
            });

            input.addEventListener('keydown', (e) => {
                if (e.key === 'Backspace' && index > 0 && !e.target.value) {
                    otpInputs[index - 1].focus();
                }
            });
        });

        function validateForm() {
            let isValid = true;
            clearErrors();

            if (!userData.firstName) {
                document.getElementById("firstNameError").textContent = "First name is required";
                isValid = false;
            }

            if (!userData.lastName) {
                document.getElementById("lastNameError").textContent = "Last name is required";
                isValid = false;
            }

            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!userData.email || !emailRegex.test(userData.email)) {
                document.getElementById("emailError").textContent = "Please enter a valid email";
                isValid = false;
            }

            if (!userData.phone) {
                document.getElementById("phoneError").textContent = "Phone number is required";
                isValid = false;
            }

            if (!userData.password || userData.password.length < 6) {
                document.getElementById("passwordError").textContent = "Password must be at least 6 characters";
                isValid = false;
            }

            if (userData.password !== userData.confirmPassword) {
                document.getElementById("confirmPasswordError").textContent = "Passwords do not match";
                isValid = false;
            }

            if (!document.getElementById("terms").checked) {
                document.getElementById("termsError").textContent = "You must accept the terms";
                isValid = false;
            }

            return isValid;
        }

        function clearErrors() {
            document.querySelectorAll('.error-message').forEach(el => {
                el.textContent = '';
            });
        }

        function toggleSpinner(show) {
            if (spinner) {
                spinner.classList.toggle("show", show);
            }
        }
        async function sendOtpRequest(email) {
            try {
                const response = await fetch(`${API_BASE}/send-otp`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ email })
                });

                // Backend düz String dönerse text() ile oku
                const text = await response.text();

                if (!response.ok) {
                    // 400, 500 gibi durumlarda buraya düşer
                    throw new Error("Failed to send OTP: " + text);
                }

                console.log("OTP gönderildi:", text);
                return text;
            } catch (error) {
                console.error("OTP Error:", error);
                alert("Error: " + error.message);
                throw error;
            }
        }

        registerFormElement.addEventListener("submit", async function(e) {
            e.preventDefault();

            userData = {
                firstName: document.getElementById("firstName").value.trim(),
                lastName: document.getElementById("lastName").value.trim(),
                email: document.getElementById("email").value.trim(),
                phone: document.getElementById("phone").value.trim(),
                password: document.getElementById("password").value,
                confirmPassword: document.getElementById("confirmPassword").value
            };

            if (!validateForm()) return;

            toggleSpinner(true);

            try {
                await sendOtpRequest(userData.email);

                registerForm.style.display = "none";
                otpForm.style.display = "block";
                userEmailSpan.textContent = userData.email;
                otpInputs[0].focus();
            } finally {
                toggleSpinner(false);
            }
        });

        verifyOtpBtn.addEventListener("click", async function() {
            const otp = Array.from(otpInputs).map(input => input.value).join("");

            if (otp.length !== 4) {
                alert("Please enter the 4-digit OTP");
                return;
            }

            toggleSpinner(true);

            try {
                const response = await fetch(`${API_BASE}/register`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        email: userData.email,
                        password: userData.password,
                        otp: otp,
                        firstName: userData.firstName,
                        lastName: userData.lastName,
                        phone: userData.phone,
                        verified: false
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error("Failed to send OTP: " + errorText);
                }

                alert("Registration successful! You can now login.");
                window.location.href = "/LogIn";
            } catch (error) {
                alert("Error: " + error.message);
                console.error("Registration Error:", error);
            } finally {
                toggleSpinner(false);
            }
        });

        resendOtpBtn.addEventListener("click", async function() {
            toggleSpinner(true);

            try {
                await sendOtpRequest(userData.email);

                alert("New OTP has been sent to your email");
                otpInputs.forEach(input => input.value = '');
                otpInputs[0].focus();
            } finally {
                toggleSpinner(false);
            }
        });
    });

</script>
</body>
</html>